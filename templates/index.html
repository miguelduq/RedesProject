<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Would You Rather - Python WebSocket</title>

  <style>
    /* começa sempre escondido */
    #questionSection {
      display: none;
    }

    #sendQuestionSection {
      display: none;
    }

    #startGameSection {
      display: none;
    }

    #playersSection {
      display: none;
    }

    #waitingScreen {
      display: none;
    }

  </style>

</head>
<body>
  <h1>Would You Rather (Demo com Flask-SocketIO)</h1>

  <div id="createRoomSection">
    <button id="btnCreateRoom">Criar Sala (Host)</button>
    <p id="roomInfo"></p>
  </div>

  
  <div id="joinRoomSection">
    <hr>
    <h3>Entrar em uma sala</h3>
    <input id="roomCodeInput" placeholder="Código da sala" />
    <input id="playerNameInput" placeholder="Seu nome" />
    <button id="btnJoinRoom">Entrar</button>
  </div>

  
  <div id="sendQuestionSection">
    <hr>
    <h3>Host: enviar pergunta</h3>
    <button id="btnSendQuestion">Enviar pergunta</button>
  </div>

  <div id="startGameSection">
    <hr>
    <button id="btnStartGame">Iniciar jogo</button>
  </div>

  
  <div id="playersSection">
    <hr>
    <h3>Jogadores na sala:</h3>
    <pre id="playersList"></pre>
  </div>

  
  <div id="questionSection">
    <hr>
    <h3>Pergunta atual:</h3>
    <p id="questionText"></p>
    
    <button id="btnChooseA">Escolher A</button>
    <button id="btnChooseB">Escolher B</button>
  </div>
  
  <div id="waitingScreen" style="margin-top:20px;">
    <h2>Apenas aguardando o Host iniciar a partida...</h2>
  </div>

  <p id="messages" style="color:red;"></p>

  <!-- Socket.IO client -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <script>
    const socket = io(); // conecta no mesmo host/porta do Flask

    let currentRoomCode = null;
    let isHost = false; // aqui: por padrão ninguém é host


    // lista jogadores
    const playersSection = document.getElementById("playersSection");
    const playersList     = document.getElementById("playersList");

    // Questions Section
    const questionSection = document.getElementById("questionSection");
    const questionText    = document.getElementById("questionText");
    const btnChooseA      = document.getElementById("btnChooseA");
    const btnChooseB      = document.getElementById("btnChooseB");

    // waiting screen 
    const waitingScreen = document.getElementById("waitingScreen");

    // create Room Section
    const btnCreateRoom   = document.getElementById("btnCreateRoom");
    const createRoomSection = document.getElementById("createRoomSection");
    const roomInfo        = document.getElementById("roomInfo");

    // entrar na sala
    const joinRoomSection = document.getElementById("joinRoomSection");
    const roomCodeInput   = document.getElementById("roomCodeInput");
    const playerNameInput = document.getElementById("playerNameInput");
    const btnJoinRoom     = document.getElementById("btnJoinRoom");

    // mandar perguntas
    const sendQuestionSection = document.getElementById("sendQuestionSection");
    const btnSendQuestion = document.getElementById("btnSendQuestion");

    // iniciar jogo
    const startGameSection = document.getElementById("startGameSection");
    const btnStartGame    = document.getElementById("btnStartGame");

    // messages 
    const messages        = document.getElementById("messages");
    



    // criar sala (host)
    btnCreateRoom.onclick = () => {
      const roomCode = prompt("Digite o código da sala que você quer criar (ex: SALA123):");

      if (!roomCode) {
        return; // usuário cancelou ou deixou vazio
      }

      socket.emit("createRoom", { roomCode });
    };

    // sala criada
    socket.on("roomCreated", ({ roomCode }) => {
      currentRoomCode = roomCode;
      isHost = true; // você é o host dessa sala

      roomInfo.textContent = "Você é o host da sala: " + roomCode;
      messages.textContent = "";

      // host não precisa mais ver a parte de entrar em sala
      joinRoomSection.style.display = "none";

      // mostrar o botao de inciar 
      startGameSection.style.display = "block";

      // se quiser, também pode desabilitar o botão
      btnCreateRoom.disabled = true;
    });




    // entrar na sala
    btnJoinRoom.onclick = () => {
      const roomCode   = roomCodeInput.value.trim();
      const playerName = playerNameInput.value.trim();

      if (!roomCode || !playerName) {
        messages.textContent = "Preencha o código da sala e seu nome.";
        return;
      }

      currentRoomCode = roomCode;
      isHost = false; // quem entra é jogador, não host
      socket.emit("joinRoom", { roomCode, playerName });

      // Esconde opções de criar sala
      createRoomSection.style.display = "none";

      // Esconde opções de mandar perguntas
      sendQuestionSection.style.display = "none";

      // Esconde a área de entrar em sala
      joinRoomSection.style.display = "none";

      // MOSTRA tela de aguardo
      waitingScreen.style.display = "block";
    };


    // atualização de jogadores
    socket.on("playersUpdate", ({ players }) => {

      playersSection.style.display = "block";

      const nomes = Object.values(players);

      if (nomes.length === 0) {
        playersList.textContent = "Nenhum jogador conectado ainda.";
      } else {
        playersList.textContent = nomes.map(n => "- " + n).join("\n");
      }
    });



    // erros
    socket.on("errorMessage", (msg) => {
      messages.textContent = msg;
    });




    // iniciar jogo (host)
    btnStartGame.onclick = () => {
      if (!currentRoomCode) {
        messages.textContent = "Nenhuma sala ativa.";
        return;
      }
      socket.emit("startGame", { roomCode: currentRoomCode });
    };

    socket.on("gameStarted", () => {

      if (isHost) {
        // HOST: vê a pergunta, mas NÃO vê os botões de resposta
        btnChooseA.style.display = "none";
        btnChooseB.style.display = "none";
      } else {
        // JOGADOR: vê a pergunta e os botões
        btnChooseA.style.display = "inline-block";
        btnChooseB.style.display = "inline-block";
        }

      messages.textContent = "Jogo iniciado!";

      questionSection.style.display = "block";

      sendQuestionSection.style.display = "block";

      startGameSection.style.display = "none";

      waitingScreen.style.display = "none";

      playersSection.style.display = "none";
    });




    // enviar pergunta (host)
    btnSendQuestion.onclick = () => {
      if (!currentRoomCode) {
        messages.textContent = "Nenhuma sala ativa.";
        return;
      }

      // const optionA = optA.value.trim();
      // const optionB = optB.value.trim();

      // if (!optionA || !optionB) {
      //   messages.textContent = "Preencha as duas opções.";
      //   return;
      // }

      socket.emit("sendQuestion", {
        roomCode: currentRoomCode,
      });
    };

    // receber nova pergunta
    socket.on("newQuestion", ({ optionA, optionB }) => {
      questionText.textContent = `Você prefere: A) ${optionA}  OU  B) ${optionB}`;
      messages.textContent = "";
    });




    // resposta do jogador
    btnChooseA.onclick = () => {
      if (currentRoomCode) {
        socket.emit("submitAnswer", { roomCode: currentRoomCode, choice: "A" });
      }
    };

    btnChooseB.onclick = () => {
      if (currentRoomCode) {
        socket.emit("submitAnswer", { roomCode: currentRoomCode, choice: "B" });
      }
    };

    socket.on("answerReceived", ({ choice }) => {
      messages.textContent = "Resposta enviada: " + choice;
    });
  </script>
</body>
</html>
